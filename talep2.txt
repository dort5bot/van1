bu dosyadaki iÃ§erikleri istenen modÃ¼l ve bu modÃ¼lÃ¼n yapÄ±sÄ±nÄ± aÃ§Ä±klar
=================================================================
===	istenen analiz modÃ¼lÃ¼ne ait Ã¶zellikler
=================================================================
Notlar:Gerekli Endpoint ÅŸunlar iÃ§in /fapi/v1/account + /fapi/v1/positionRisk + /fapi/v2/balance yerine /fapi/v2/account kullanÄ±lacak

ModÃ¼l adÄ± -  .py dosya adÄ± -  Gerekli Endpoint(ler) -  API TÃ¼rÃ¼ -  eklenecek Zorunlu Klasik Metrikler -  eklenecek Profesyonel Metrikler (Ã¶ncelik: * yÃ¼ksek / ** orta / *** dÃ¼ÅŸÃ¼k) -  AmaÃ§ -  Ã‡Ä±ktÄ± TÃ¼rÃ¼ -  Komut -  Ä°ÅŸ Tipi -  Paralel TÃ¼r -  
A. Trend & Momentum (TA) -  trend_moment.py -  /api/v3/klines, /api/v3/ticker/24hr, /api/v3/avgPrice -  Spot Public -  EMA, RSI, MACD, Bollinger Bands, ATR + ADX (Directional Index), Stochastic RSI, Momentum Oscillator -  *Kalman Filter Trend, *Z-Score Normalization, **Wavelet Transform, **Hilbert Transform Slope, **Fractal Dimension Index (FDI) -  Fiyat yÃ¶nÃ¼ & momentum gÃ¼cÃ¼ -  Trend Score (0â€“1) -  /trend, /t -  CPU-bound -  Batch -  




--------------------------------
bu modÃ¼lÃ¼n yapÄ±sÄ± ÅŸu yapÄ±da olmalÄ±dÄ±r
---------------------------------
1- dosya yapÄ±sÄ± agaÃ§ yapÄ±
2- modÃ¼llerin genel Ã¶zellikleri
3- modÃ¼l iÃ§in ÅŸablon
4- modÃ¼le ait config ÅŸablonu
5- veri kaynaÄŸÄ± sÄ±nÄ±f ve alt endpoid isim bilgisi

=================================================================
===	1 dosya yapÄ±sÄ± agÃ§a yapÄ±
=================================================================
analysis/
â”œâ”€â”€ analysis_base_module.py          # 
â”œâ”€â”€ analysis_core.py                 # Ana aggregator
â”œâ”€â”€ analysis_router.py               # FastAPI router
â”œâ”€â”€ analysis_schema_manager.py       # Schema yÃ¶neticisi
â”œâ”€â”€ analysis_metric_schema.yaml      # Schema tanÄ±mÄ±
â”œâ”€â”€ trend_moment.py                  # ModÃ¼l implementasyonlarÄ±
â”‚
â”œâ”€â”€ config/					# modÃ¼ller iÃ§in Hybrid config YapÄ±
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py              # Base config sÄ±nÄ±flarÄ±
â”‚   â”œâ”€â”€ trend.py             # Trend-specific config
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ loader.py            # Merkezi config yÃ¼kleyici
â”œâ”€â”€ analysis_base_module.py
â”œâ”€â”€ analysis_core.py
â””â”€â”€ ...

=================================================================
===	2- modÃ¼llerin genel Ã¶zellikleri
=================================================================
liste modÃ¼l geliÅŸtirme iÃ§in kontrol Ã§erÃ§evesi
---
Ã¶n hedef:
class tabanlÄ± (BaseAnalysisModule),
config tabanlÄ± (configTrend.py),
async & batch uyumlu,
skorlamasÄ± aÃ§Ä±klanabilir,
doÄŸru metrik formÃ¼lleri,
vektÃ¶rize edilmiÅŸ,
kalibrasyon, threshold, explain alanÄ±,
Prometheus / metric wrapperâ€™larÄ± ile uyumlu ÅŸekilde tasarlanan modÃ¼ller

## ðŸ§± 1ï¸âƒ£ YapÄ±sal TutarlÄ±lÄ±k (Structure & Naming)
**AmaÃ§:** Kod okunabilirliÄŸi, modÃ¼ller arasÄ± standardizasyon.
* âœ… Metrik isimlendirmeleri tutarlÄ± (Ã¶r. `ema`, `rsi`, `macd_hist`, `kalman_trend`).
* âœ… Class tabanlÄ± yapÄ± mevcut (`class TrendModule(BaseAnalysisModule): ...`).
Interface/Abstract Base Class kullanÄ±mÄ±
* âœ… Her modÃ¼l aynÄ± temel fonksiyon imzasÄ±na sahip:
  * `compute_metrics()`
  * `aggregate_output()`
  * `generate_report()`
* âœ… ModÃ¼l baÅŸÄ±na ayrÄ± config dosyasÄ±:
  * `configModÃ¼lAdÄ±.py` (Ã¶rnek: `configTrend.py`)
* âœ… Birden fazla sembol aynÄ± anda analiz edilebilir (multi-symbol loop veya batch job destekli).
* âœ… Paralel yapÄ± tÃ¼rÃ¼ (`Batch / Async / Stream`) tanÄ±mlanmÄ±ÅŸ.



## âš™ï¸ 2ï¸âƒ£ Hesaplama Kalitesi & Metrik GÃ¼venirliÄŸi

**AmaÃ§:** Hesaplanan metriklerin akademik/istatistiksel olarak doÄŸru olmasÄ±.
* âœ… Metrikler doÄŸru formÃ¼lle hesaplanÄ±yor (Ã¶r. RSI = 100 - 100/(1+RS)).
* âœ… Parametrik config deÄŸerleri doÄŸru kullanÄ±lÄ±yor (Ã¶r. EMA period, Bollinger window).
* âœ… Hesaplanan metriklerin gerÃ§ek ve kullanÄ±labilir deÄŸer aralÄ±klarÄ± var.
* âœ… Numpy/pandas ile **vektÃ¶rize edilmiÅŸ hesaplamalar** â€” for dÃ¶ngÃ¼leri minimize edilmiÅŸ.
* âœ… Ä°leri metrikler iÃ§in uygun kÃ¼tÃ¼phaneler kullanÄ±lmÄ±ÅŸ:
  * `pykalman` â†’ Kalman Filter
  * `pywt` â†’ Wavelet
  * `scipy.signal` â†’ Hilbert / detrend
* âœ… Metric dependency graph mevcut (Ã¶r. RSI, EMAâ€™ya baÄŸlÄ±ysa Ã¶nce EMA hesaplanÄ±r).
Metrik hesaplamalarÄ± iÃ§in @validate_inputs gibi bir decorator kullanÄ±labilir.


## âš–ï¸ 3ï¸âƒ£ Skorlama, Normalizasyon & Explainability
**AmaÃ§:** ModÃ¼lÃ¼n Ã¼rettiÄŸi skoru anlamlandÄ±rÄ±labilir, aÃ§Ä±klanabilir hale getirmek.
* âœ… Skorlama formÃ¼lÃ¼ aÃ§Ä±kÃ§a tanÄ±mlÄ± (Ã¶r. `trend_score = w1*EMA + w2*RSI + ...`).
* âœ… AÄŸÄ±rlÄ±klar config iÃ§inde (`weights = {"ema":0.2, "rsi":0.2, "macd":0.3, ...}`).
* âœ… Normalize iÅŸlemi (Z-Score, Min-Max veya Percentile) uygulanmÄ±ÅŸ.
* âœ… `explain` alanÄ± dÃ¶ndÃ¼rÃ¼lÃ¼yor:
* âœ… Threshold & uyarÄ± sistemi:
  `score > 0.7 â†’ "bullish"`, `score < 0.3 â†’ "bearish"`, aksi â€œneutralâ€.
* âœ… Opsiyonel: Kalibrasyon (rolling z-score veya exponentially weighted scaling).
Shapley deÄŸeri veya permutation importance gibi metodlar opsiyonel explainability katmanlarÄ± olarak eklenebilir


## ðŸš€ 4ï¸âƒ£ Performans & Paralel Ä°ÅŸleme Modeli
**AmaÃ§:** Ã‡oklu sembolde yÃ¼ksek performans, dÃ¼ÅŸÃ¼k gecikme.
* âœ… CPU-bound iÅŸlemler (`Kalman`, `GARCH`) â†’ **ThreadPool / ProcessPool**.
* âœ… IO-bound iÅŸlemler (API fetch, WebSocket) â†’ **AsyncIO**.
* âœ… Stream modÃ¼llerinde sÃ¼rekli async iterator (`async for`) yapÄ±sÄ±.
* âœ… Vectorization ve caching aktif.
* âœ… Rate-limit handling (Binance API â†’ backoff, retry).
* âœ… Resource cleanup: context manager (`with` yapÄ±sÄ± veya async context).
* âœ… Cache TTL (Ã¶r. Redis veya internal LRU cache) tanÄ±mlÄ±.
asyncio.TaskGroup (Python 3.11+) kullanÄ±mÄ± Ã¶nerilebilir, daha modern ve kontrol edilebilir.
Opsiyonel: joblib veya ray gibi paralel iÅŸlem motorlarÄ± desteklenebilir.

## ðŸ§© 5ï¸âƒ£ DokÃ¼mantasyon & Validation
**AmaÃ§:** ModÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±, hangi metrikleri kullandÄ±ÄŸÄ± aÃ§Ä±kÃ§a gÃ¶rÃ¼lebilsin
* âœ… Her modÃ¼lÃ¼n baÅŸÄ±nda docstring:
  ```python
  """Trend & Momentum Analysis
  Metrikler: EMA, RSI, MACD, Kalman
  Ã‡Ä±ktÄ±: trend_score (0â€“1)
  """
  ```

## ðŸ§  6ï¸âƒ£ Ä°leri Katmanlar (Opsiyonel ama gÃ¼Ã§lÃ¼)
**AmaÃ§:** Profesyonel seviye Ã¶lÃ§eklenebilirlik ve izlenebilirlik.
* âœ… Metric Dependency Graph (DAG) otomatik Ã§Ã¶zÃ¼lÃ¼yor.
* âœ… ModÃ¼l baÄŸÄ±mlÄ±lÄ±klarÄ± schema iÃ§inde tanÄ±mlÄ±.
* âœ… Opsiyonel: Prometheus / Grafana entegrasyonu (metric_export).
* âœ… AsyncIO + ThreadPool mix (CPU + IO hibrit).
* âœ… Versiyonlama: `version = "1.0.0"` modÃ¼l baÅŸÄ±nda belirtilmiÅŸ.

7. GÃ¼venlik ve Veri BÃ¼tÃ¼nlÃ¼ÄŸÃ¼
# âœ… Input validation ve sanitization
# âœ… API key management (environment variables, vault)
# âœ… Rate limiting ve quota management
# âœ… Data integrity checks (checksum, signature verification)

8. Backtesting ve Historical Validation
# âœ… Historical accuracy testing
# âœ… Walk-forward analysis capability
# âœ… Benchmark comparison (vs buy-and-hold)
# âœ… Drawdown and risk metrics
9. Deployment ve DevOps
# âœ… Containerization (Dfile)
# âœ… Health check endpoints
# âœ… Configuration management (feature flags)
# âœ… Rolling update capability


=================================================================
===	3- modÃ¼l iÃ§in ÅŸablon
=================================================================
"""
Trend & Momentum Analysis Module
================================
Versiyon: 2.2.0 | Lifecycle: Production | Config: config_trend.py

ðŸ“Š METRÄ°KLER:
- EMA (9, 21, 50)
- RSI (14)
- MACD (12, 26, 9)
- Kalman Filter Trend
- Z-Score Normalization

ðŸŽ¯ Ã‡IKTILAR:
- trend_score (0-1)
- signal (bullish/neutral/bearish)
- momentum_strength
- explainability components

ðŸ”§ Ã–ZELLÄ°KLER:
- VektÃ¶rize hesaplama
- Type-safe config entegrasyonu
- Composite formula desteÄŸi
- Prometheus metrikleri
"""

import logging
import numpy as np
import pandas as pd
from datetime import datetime
from typing import Dict, Any, Optional

from prometheus_client import Counter, Gauge, Histogram
from analysis.analysis_base_module import BaseAnalysisModule, legacy_compatible
from analysis.config.loader import config_manager
# Binance API imports
from utils.binance_api.binance_a import BinanceAggregator, MultiUserBinanceAggregator


logger = logging.getLogger(__name__)

# Prometheus
TREND_SCORE_GAUGE = Gauge('trend_score', 'Trend analysis score', ['symbol'])
ANALYSIS_DURATION = Histogram('analysis_duration_seconds', 'Execution time', ['module'])
ERROR_COUNTER = Counter('analysis_errors_total', 'Analysis errors', ['module'])


@legacy_compatible
class TrendModule(BaseAnalysisModule):
    """Trend ve momentum analizi"""

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        if config is None:
            config_data = config_manager.get_config('trend')
            config = config_data.dict() if config_data else {}
        super().__init__(config)

        self.module_name = "TrendAnalysis"
        self.version = "2.2.0"
        self.dependencies = ["ema", "rsi", "macd", "kalman", "zscore"]

    async def compute_metrics(self, symbol: str) -> Dict[str, Any]:
        start = datetime.utcnow()
        try:
            ANALYSIS_DURATION.labels(module='trend').time()
            data = await self._fetch_ohlcv_data(symbol, interval="1h", limit=200)
            metrics = await self._calculate_metrics(data)
            result = self._aggregate(metrics)

            TREND_SCORE_GAUGE.labels(symbol=symbol).set(result["score"])
            return {
                **result,
                "metadata": {
                    "symbol": symbol,
                    "timestamp": start.isoformat() + "Z",
                    "version": self.version
                }
            }
        except Exception as e:
            ERROR_COUNTER.labels(module='trend').inc()
            logger.error(f"Trend computation failed for {symbol}: {e}")
            return {"score": 0.5, "signal": "neutral"}

    async def _calculate_metrics(self, df: pd.DataFrame) -> Dict[str, float]:
        """VektÃ¶rize metrik hesaplamalarÄ±"""
        close = df['close']
        params = self.config.get("parameters", {})
        metrics = {}

        # EMA
        for p in params.get("ema_periods", [9, 21, 50]):
            metrics[f"ema_{p}"] = float(close.ewm(span=p, adjust=False).mean().iloc[-1])

        # RSI
        diff = close.diff()
        gain = diff.clip(lower=0).rolling(params.get("rsi_period", 14)).mean()
        loss = -diff.clip(upper=0).rolling(params.get("rsi_period", 14)).mean()
        rs = gain / (loss + 1e-9)
        metrics["rsi"] = float((100 - (100 / (1 + rs))).iloc[-1] / 100)

        # MACD
        fast, slow, signal = params.get("macd_params", {"fast": 12, "slow": 26, "signal": 9}).values()
        ema_fast = close.ewm(span=fast).mean()
        ema_slow = close.ewm(span=slow).mean()
        macd = ema_fast - ema_slow
        macd_signal = macd.ewm(span=signal).mean()
        metrics["macd_histogram"] = float(macd.sub(macd_signal).iloc[-1])

        # Kalman & Z-score
        metrics["kalman_trend"] = float(np.clip(np.mean(close.pct_change()) / (np.std(close.pct_change()) + 1e-9), 0, 1))
        metrics["z_score"] = float(((close - close.rolling(20).mean()) / close.rolling(20).std()).iloc[-1])

        return metrics

    def _aggregate(self, metrics: Dict[str, float]) -> Dict[str, Any]:
        weights = self.config.get("weights", {})
        thresholds = self.config.get("thresholds", {})
        formula = self.config.get("composite_formula")

        if formula:
            # Dinamik formÃ¼l Ã§Ã¶zÃ¼mleme
            local_env = {k: v for k, v in metrics.items()}
            try:
                score = eval(formula, {}, local_env)
            except Exception:
                score = sum(v * weights.get(k, 0) for k, v in metrics.items())
        else:
            score = sum(v * weights.get(k, 0) for k, v in metrics.items())

        score = float(np.clip(score, 0, 1))
        signal = "bullish" if score >= thresholds["bullish"] else "bearish" if score <= thresholds["bearish"] else "neutral"

        return {
            "score": score,
            "signal": signal,
            "components": metrics
        }







=================================================================
===	4- modÃ¼le ait config ÅŸablonu
=================================================================
"""
Trend Analysis Module Configuration
-----------------------------------
Versiyon: 2.2.0 | Lifecycle: Production

ðŸ”§ Bu ÅŸablon, trend analiz modÃ¼lÃ¼ iÃ§in tip gÃ¼venli (type-safe) yapÄ± sunar.
TÃ¼m parametreler modÃ¼l ile tam uyumludur.
"""

from typing import Dict, Any, List, Optional
from pydantic import BaseModel, Field, validator

from analysis.config.base import BaseModuleConfig


class TrendConfig(BaseModuleConfig):
    """Trend modÃ¼lÃ¼ iÃ§in tip gÃ¼venli config"""

    # === PARAMETRELER ===
    parameters: Dict[str, Any] = Field(
        default_factory=lambda: {
            "ema_periods": [9, 21, 50],
            "rsi_period": 14,
            "macd_params": {"fast": 12, "slow": 26, "signal": 9},
            "kalman_observation_noise": 0.1,
            "zscore_window": 20
        },
        description="Trend analizinde kullanÄ±lacak parametre seti"
    )

    # === AÄžIRLIKLAR ===
    weights: Dict[str, float] = Field(
        default_factory=lambda: {
            "ema_9": 0.15,
            "ema_21": 0.15,
            "ema_50": 0.10,
            "rsi": 0.20,
            "macd_histogram": 0.25,
            "kalman_trend": 0.15
        },
        description="Her metrik iÃ§in aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ±"
    )

    # === EÅžÄ°KLER ===
    thresholds: Dict[str, float] = Field(
        default_factory=lambda: {
            "bullish": 0.65,
            "bearish": 0.35,
            "strong_trend": 0.75,
            "weak_trend": 0.25
        },
        description="Sinyal Ã¼retiminde kullanÄ±lacak eÅŸikler"
    )

    # === NORMALÄ°ZASYON ===
    normalization: Dict[str, str] = Field(
        default_factory=lambda: {"method": "zscore"},
        description="Normalizasyon yÃ¶ntemi"
    )

    # === PERFORMANS AYARLARI ===
    performance: Dict[str, Any] = Field(
        default_factory=lambda: {"cache_ttl": 300, "timeout": 30, "max_retries": 3},
        description="Performans ve Ã¶nbellek ayarlarÄ±"
    )

    # === BÄ°LEÅžÄ°K FORMÃœL (Opsiyonel) ===
    composite_formula: Optional[str] = Field(
        default="0.25*macd_histogram + 0.2*rsi + 0.2*ema_21 + 0.15*kalman_trend + 0.1*z_score + 0.1*ema_9",
        description="AÄŸÄ±rlÄ±klÄ± metrikleri birleÅŸtiren Ã¶zel formÃ¼l (opsiyonel)"
    )

    # === VALIDATORS ===
    @validator('weights')
    def validate_weights(cls, v):
        total = sum(v.values())
        if not 0.99 <= total <= 1.01:
            raise ValueError(f"Weights must sum to 1.0, got {total:.3f}")
        return v

    @validator('thresholds')
    def validate_thresholds(cls, v):
        if 'bullish' in v and 'bearish' in v:
            if v['bullish'] <= v['bearish']:
                raise ValueError('Bullish threshold must be greater than bearish threshold')
        return v


# === CONFIG INSTANCE ===
TREND_CONFIG = TrendConfig(
    module_name="TrendAnalysis",
    version="2.2.0",
    lifecycle="production"
)






=================================================================
===	5- veri kaynaÄŸÄ± sÄ±nÄ±f ve alt endpoid isim bilgisi
=================================================================

# Binance API imports
from utils.binance_api.binance_a import BinanceAggregator, MultiUserBinanceAggregator
Notlar:/fapi/v1/account + /fapi/v1/positionRisk + /fapi/v2/balance yerine /fapi/v2/account kullanÄ±lacak

