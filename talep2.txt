bu dosyadaki iÃ§erikleri istenen modÃ¼l ve bu modÃ¼lÃ¼n yapÄ±sÄ±nÄ± aÃ§Ä±klar
=================================================================
===	istenen analiz modÃ¼lÃ¼ne ait Ã¶zellikler
=================================================================
ModÃ¼l adÄ± -  .py dosya adÄ± -  Gerekli Endpoint(ler) -  API TÃ¼rÃ¼ -  eklenecek Zorunlu Klasik Metrikler -  eklenecek Profesyonel Metrikler (Ã¶ncelik: * yÃ¼ksek / ** orta / *** dÃ¼ÅŸÃ¼k) -  AmaÃ§ -  Ã‡Ä±ktÄ± TÃ¼rÃ¼ -  Komut -  Ä°ÅŸ Tipi -  Paralel TÃ¼r -  
A. Trend & Momentum (TA) -  trend_moment.py -  /api/v3/klines, /api/v3/ticker/24hr, /api/v3/avgPrice -  Spot Public -  EMA, RSI, MACD, Bollinger Bands, ATR + ADX (Directional Index), Stochastic RSI, Momentum Oscillator -  *Kalman Filter Trend, *Z-Score Normalization, **Wavelet Transform, **Hilbert Transform Slope, **Fractal Dimension Index (FDI) -  Fiyat yÃ¶nÃ¼ & momentum gÃ¼cÃ¼ -  Trend Score (0â€“1) -  /trend, /t -  CPU-bound -  Batch -  
B. Piyasa Rejimi (Volatilite & YapÄ±) -  volat_regime.py -  /api/v3/klines, /fapi/v1/markPrice, /fapi/v1/fundingRate -  Spot + Futures Public -  Historical Volatility, ATR, Bollinger Width + Variance Ratio Test, Range Expansion Index -  *GARCH(1,1), *Entropy Index, **Hurst Exponent, ***Regime Switching Model -  Trend / Range modu ayrÄ±mÄ± -  Regime Label (Trend, Range) -  /regime, /rg -  CPU-bound -  Batch -  
C. Derivatives & Sentiment (Pozisyon Verileri) -  deriv_sentim.py -  /fapi/v1/fundingRate, /fapi/v1/openInterestHist, /fapi/v1/longShortRatio -  Futures Public -  Funding Rate, Open Interest (OI), Long/Short Ratio + OI Change Rate, Funding Rate Skew, Volume Imbalance Index -  *Liquidation Heatmap, **OI Delta Divergence, **Volatility Skew, ***Gamma Exposure -  Trader positioning & sentiment eÄŸilimi -  Sentiment Score (-1â†’1) -  /sentiment, /s -  I/O-bound + hafif hesap -  Async -  
D. Order Flow & Microstructure -  order_micros.py -  /fapi/v1/depth, /fapi/v1/trades, /fapi/v1/ticker/bookTicker -  Futures Public -  Orderbook Imbalance, Spread, Market Buy/Sell Pressure + Trade Aggression Ratio, Slippage, Depth Elasticity -  *CVD (Cumulative Volume Delta), **Order Flow Imbalance Index (OFI), **Taker Dominance Ratio, ***Liquidity Density Map -  AnlÄ±k yÃ¶n & likidite baskÄ±sÄ± -  Liquidity Pressure Score (0â€“1) -  /flow, /f -  Stream + CPU (karma) -  Stream -  
E. Korelasyon & Lead-Lag (Liderlik Analizi) -  corr_lead.py -  /api/v3/klines (multi-symbol), /fapi/v1/markPriceKlines -  Spot + Futures Public -  Pearson Corr, Beta, Rolling Covariance + Partial Correlation, Rolling Lead-Lag Delta -  *Granger Causality Test, *Dynamic Time Warping (DTW), **Canonical Correlation, ***Vector AutoReg (VAR) -  Coinâ€™ler arasÄ± liderlik & yÃ¶n takibi -  Correlation Lead-Lag Matrix -  /corr, /c -  CPU + I/O karÄ±ÅŸÄ±k -  Batch -  
F. On-Chain & Makro (Opsiyonel) -  onchain.py.py -  DÄ±ÅŸ kaynak: Glassnode, CryptoQuant, Farside -  External Public -  Stablecoin Flow, CEX Inflow/Outflow, ETF Net Flow + Exchange Net Position Change, Realized Cap, NUPL -  *Net Realized Profit/Loss, *Exchange Whale Ratio, **MVRV Z-Score, ***SOPR -  Zincir Ã¼stÃ¼ likidite & makro eÄŸilim -  Macro Score (0â€“1) -  /macro, /ma -  I/O-bound -  Async -  
G. Risk & Exposure Management -  risk_expos.py -  /fapi/v1/liquidationOrders, /fapi/v1/premiumIndex, /api/v3/klines -  Spot + Futures Public -  ATR Stop, Liquidation Zones, Max Drawdown + Volatility Targeting, Position Leverage Ratio -  *Value-at-Risk (VaR), *Expected Shortfall (CVaR), **Sharpe/Sortino Dynamic, ***ATR-based Adaptive Stop -  Risk kontrolÃ¼ & sinyal gÃ¼venliÄŸi -  Risk Score (0â€“1) -  /risk,/r -  - -  Batch -  
H. Market Micro Alpha (Tick-Level Alpha Factor) -  microalpha.py.py -  /fapi/v1/depth, /fapi/v1/trades, WebSocket /ws/<symbol>@trade, /ws/<symbol>@depth@100ms -  Futures Public (Real-Time) -  Tick Volume, Spread, Bid/Ask Imbalance, Trade Direction Ratio + Microprice, Quote Stability Index, Order Duration -  *Cumulative Volume Delta (CVD), *Order Flow Imbalance Index (OFI), *Microprice Deviation, **Market Impact Model (Kyleâ€™s Î»), **Latency Adjusted Flow Ratio, ***High-Frequency Z-score -  GerÃ§ek zamanlÄ± mikro-yapÄ± yÃ¶nÃ¼ ve hacimsel alpha faktÃ¶rÃ¼ Ã¼retmek -  Micro Alpha Score (0â€“1) -  /micro, /mi -  - -  Async -  
I. Portfolio Optimization & Allocation -  port_alloc.py -  /api/v3/account, /fapi/v2/balance -  Private -  Sharpe Ratio, Correlation Matrix, VaR + Conditional Beta, Sortino Ratio, Drawdown Correlation -  *Black-Litterman Model, **Hierarchical Risk Parity (HRP), ***Risk Parity -  Dinamik portfolio optimizasyonu -  Allocation Weights -  /allocate, /al -  - -  Batch -  
J. Regime Change Detection & Anomaly -  regime_anomal.py -  /api/v3/klines, /fapi/v1/markPrice -  Spot + Futures -  Z-Score, Rolling Mean/Std + Rolling Skewness/Kurtosis, Cumulative Return Deviation -  *Changepoint Detection (CUSUM), **Isolation Forest, ***Spectral Residual -  Ani deÄŸiÅŸim ve anomaly tespiti -  Anomaly Score (0-1) -  /redet, /rd -  - -  Async -  




--------------------------------
bu modÃ¼lÃ¼n yapÄ±sÄ± ÅŸu yapÄ±da olmalÄ±dÄ±r
---------------------------------
1- dosya yapÄ±sÄ± agaÃ§ yapÄ±
2- modÃ¼llerin genel Ã¶zellikleri
3- modÃ¼l iÃ§in ÅŸablon
4- modÃ¼le ait config ÅŸablonu
5- veri kaynaÄŸÄ± sÄ±nÄ±f ve alt endpoid isim bilgisi

=================================================================
===	1 dosya yapÄ±sÄ± agÃ§a yapÄ±
=================================================================
analysis/
â”œâ”€â”€ analysis_base_module.py          # 
â”œâ”€â”€ analysis_core.py                 # Ana aggregator
â”œâ”€â”€ analysis_router.py               # FastAPI router
â”œâ”€â”€ analysis_schema_manager.py       # Schema yÃ¶neticisi
â”œâ”€â”€ analysis_metric_schema.yaml      # Schema tanÄ±mÄ±
â”œâ”€â”€ trend_moment.py                  # ModÃ¼l implementasyonlarÄ±
â”‚
â”œâ”€â”€ config/					# modÃ¼ller iÃ§in Hybrid config YapÄ±
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py              # Base config sÄ±nÄ±flarÄ±
â”‚   â”œâ”€â”€ trend.py             # Trend-specific config
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ loader.py            # Merkezi config yÃ¼kleyici
â”œâ”€â”€ analysis_base_module.py
â”œâ”€â”€ analysis_core.py
â””â”€â”€ ...

=================================================================
===	2- modÃ¼llerin genel Ã¶zellikleri
=================================================================
liste modÃ¼l geliÅŸtirme iÃ§in kontrol Ã§erÃ§evesi
---
Ã¶n hedef:
class tabanlÄ± (BaseAnalysisModule),
config tabanlÄ± (configTrend.py),
async & batch uyumlu,
skorlamasÄ± aÃ§Ä±klanabilir,
doÄŸru metrik formÃ¼lleri,
vektÃ¶rize edilmiÅŸ,
kalibrasyon, threshold, explain alanÄ±,
Prometheus / metric wrapperâ€™larÄ± ile uyumlu ÅŸekilde tasarlanan modÃ¼ller

## ðŸ§± 1ï¸âƒ£ YapÄ±sal TutarlÄ±lÄ±k (Structure & Naming)
**AmaÃ§:** Kod okunabilirliÄŸi, modÃ¼ller arasÄ± standardizasyon.
* âœ… Metrik isimlendirmeleri tutarlÄ± (Ã¶r. `ema`, `rsi`, `macd_hist`, `kalman_trend`).
* âœ… Class tabanlÄ± yapÄ± mevcut (`class TrendModule(BaseAnalysisModule): ...`).
Interface/Abstract Base Class kullanÄ±mÄ±
* âœ… Her modÃ¼l aynÄ± temel fonksiyon imzasÄ±na sahip:
  * `compute_metrics()`
  * `aggregate_output()`
  * `generate_report()`
* âœ… ModÃ¼l baÅŸÄ±na ayrÄ± config dosyasÄ±:
  * `configModÃ¼lAdÄ±.py` (Ã¶rnek: `configTrend.py`)
* âœ… Birden fazla sembol aynÄ± anda analiz edilebilir (multi-symbol loop veya batch job destekli).
* âœ… Paralel yapÄ± tÃ¼rÃ¼ (`Batch / Async / Stream`) tanÄ±mlanmÄ±ÅŸ.



## âš™ï¸ 2ï¸âƒ£ Hesaplama Kalitesi & Metrik GÃ¼venirliÄŸi

**AmaÃ§:** Hesaplanan metriklerin akademik/istatistiksel olarak doÄŸru olmasÄ±.
* âœ… Metrikler doÄŸru formÃ¼lle hesaplanÄ±yor (Ã¶r. RSI = 100 - 100/(1+RS)).
* âœ… Parametrik config deÄŸerleri doÄŸru kullanÄ±lÄ±yor (Ã¶r. EMA period, Bollinger window).
* âœ… Hesaplanan metriklerin gerÃ§ek ve kullanÄ±labilir deÄŸer aralÄ±klarÄ± var.
* âœ… Numpy/pandas ile **vektÃ¶rize edilmiÅŸ hesaplamalar** â€” for dÃ¶ngÃ¼leri minimize edilmiÅŸ.
* âœ… Ä°leri metrikler iÃ§in uygun kÃ¼tÃ¼phaneler kullanÄ±lmÄ±ÅŸ:
  * `pykalman` â†’ Kalman Filter
  * `pywt` â†’ Wavelet
  * `scipy.signal` â†’ Hilbert / detrend
* âœ… Metric dependency graph mevcut (Ã¶r. RSI, EMAâ€™ya baÄŸlÄ±ysa Ã¶nce EMA hesaplanÄ±r).
Metrik hesaplamalarÄ± iÃ§in @validate_inputs gibi bir decorator kullanÄ±labilir.


## âš–ï¸ 3ï¸âƒ£ Skorlama, Normalizasyon & Explainability
**AmaÃ§:** ModÃ¼lÃ¼n Ã¼rettiÄŸi skoru anlamlandÄ±rÄ±labilir, aÃ§Ä±klanabilir hale getirmek.
* âœ… Skorlama formÃ¼lÃ¼ aÃ§Ä±kÃ§a tanÄ±mlÄ± (Ã¶r. `trend_score = w1*EMA + w2*RSI + ...`).
* âœ… AÄŸÄ±rlÄ±klar config iÃ§inde (`weights = {"ema":0.2, "rsi":0.2, "macd":0.3, ...}`).
* âœ… Normalize iÅŸlemi (Z-Score, Min-Max veya Percentile) uygulanmÄ±ÅŸ.
* âœ… `explain` alanÄ± dÃ¶ndÃ¼rÃ¼lÃ¼yor:
* âœ… Threshold & uyarÄ± sistemi:
  `score > 0.7 â†’ "bullish"`, `score < 0.3 â†’ "bearish"`, aksi â€œneutralâ€.
* âœ… Opsiyonel: Kalibrasyon (rolling z-score veya exponentially weighted scaling).
Shapley deÄŸeri veya permutation importance gibi metodlar opsiyonel explainability katmanlarÄ± olarak eklenebilir


## ðŸš€ 4ï¸âƒ£ Performans & Paralel Ä°ÅŸleme Modeli
**AmaÃ§:** Ã‡oklu sembolde yÃ¼ksek performans, dÃ¼ÅŸÃ¼k gecikme.
* âœ… CPU-bound iÅŸlemler (`Kalman`, `GARCH`) â†’ **ThreadPool / ProcessPool**.
* âœ… IO-bound iÅŸlemler (API fetch, WebSocket) â†’ **AsyncIO**.
* âœ… Stream modÃ¼llerinde sÃ¼rekli async iterator (`async for`) yapÄ±sÄ±.
* âœ… Vectorization ve caching aktif.
* âœ… Rate-limit handling (Binance API â†’ backoff, retry).
* âœ… Resource cleanup: context manager (`with` yapÄ±sÄ± veya async context).
* âœ… Cache TTL (Ã¶r. Redis veya internal LRU cache) tanÄ±mlÄ±.
asyncio.TaskGroup (Python 3.11+) kullanÄ±mÄ± Ã¶nerilebilir, daha modern ve kontrol edilebilir.
Opsiyonel: joblib veya ray gibi paralel iÅŸlem motorlarÄ± desteklenebilir.

## ðŸ§© 5ï¸âƒ£ DokÃ¼mantasyon & Validation
**AmaÃ§:** ModÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±, hangi metrikleri kullandÄ±ÄŸÄ± aÃ§Ä±kÃ§a gÃ¶rÃ¼lebilsin
* âœ… Her modÃ¼lÃ¼n baÅŸÄ±nda docstring:
  ```python
  """Trend & Momentum Analysis
  Metrikler: EMA, RSI, MACD, Kalman
  Ã‡Ä±ktÄ±: trend_score (0â€“1)
  """
  ```

## ðŸ§  6ï¸âƒ£ Ä°leri Katmanlar (Opsiyonel ama gÃ¼Ã§lÃ¼)
**AmaÃ§:** Profesyonel seviye Ã¶lÃ§eklenebilirlik ve izlenebilirlik.
* âœ… Metric Dependency Graph (DAG) otomatik Ã§Ã¶zÃ¼lÃ¼yor.
* âœ… ModÃ¼l baÄŸÄ±mlÄ±lÄ±klarÄ± schema iÃ§inde tanÄ±mlÄ±.
* âœ… Opsiyonel: Prometheus / Grafana entegrasyonu (metric_export).
* âœ… AsyncIO + ThreadPool mix (CPU + IO hibrit).
* âœ… Versiyonlama: `version = "1.0.0"` modÃ¼l baÅŸÄ±nda belirtilmiÅŸ.

7. GÃ¼venlik ve Veri BÃ¼tÃ¼nlÃ¼ÄŸÃ¼
# âœ… Input validation ve sanitization
# âœ… API key management (environment variables, vault)
# âœ… Rate limiting ve quota management
# âœ… Data integrity checks (checksum, signature verification)

8. Backtesting ve Historical Validation
# âœ… Historical accuracy testing
# âœ… Walk-forward analysis capability
# âœ… Benchmark comparison (vs buy-and-hold)
# âœ… Drawdown and risk metrics
9. Deployment ve DevOps
# âœ… Containerization (Dfile)
# âœ… Health check endpoints
# âœ… Configuration management (feature flags)
# âœ… Rolling update capability


=================================================================
===	3- modÃ¼l iÃ§in ÅŸablon
=================================================================
"""
Trend & Momentum Analysis Module
================================
Versiyon: 2.2.0 | Lifecycle: Production | Config: config_trend.py

ðŸ“Š METRÄ°KLER:
- EMA (9, 21, 50)
- RSI (14)
- MACD (12, 26, 9)
- Kalman Filter Trend
- Z-Score Normalization

ðŸŽ¯ Ã‡IKTILAR:
- trend_score (0-1)
- signal (bullish/neutral/bearish)
- momentum_strength
- explainability components

ðŸ”§ Ã–ZELLÄ°KLER:
- VektÃ¶rize hesaplama
- Type-safe config entegrasyonu
- Composite formula desteÄŸi
- Prometheus metrikleri
"""

import logging
import numpy as np
import pandas as pd
from datetime import datetime
from typing import Dict, Any, Optional

from prometheus_client import Counter, Gauge, Histogram
from analysis.analysis_base_module import BaseAnalysisModule, legacy_compatible
from analysis.config.loader import config_manager
# Binance API imports
from utils.binance_api.binance_a import BinanceAggregator, MultiUserBinanceAggregator


logger = logging.getLogger(__name__)

# Prometheus
TREND_SCORE_GAUGE = Gauge('trend_score', 'Trend analysis score', ['symbol'])
ANALYSIS_DURATION = Histogram('analysis_duration_seconds', 'Execution time', ['module'])
ERROR_COUNTER = Counter('analysis_errors_total', 'Analysis errors', ['module'])


@legacy_compatible
class TrendModule(BaseAnalysisModule):
    """Trend ve momentum analizi"""

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        if config is None:
            config_data = config_manager.get_config('trend')
            config = config_data.dict() if config_data else {}
        super().__init__(config)

        self.module_name = "TrendAnalysis"
        self.version = "2.2.0"
        self.dependencies = ["ema", "rsi", "macd", "kalman", "zscore"]

    async def compute_metrics(self, symbol: str) -> Dict[str, Any]:
        start = datetime.utcnow()
        try:
            ANALYSIS_DURATION.labels(module='trend').time()
            data = await self._fetch_ohlcv_data(symbol, interval="1h", limit=200)
            metrics = await self._calculate_metrics(data)
            result = self._aggregate(metrics)

            TREND_SCORE_GAUGE.labels(symbol=symbol).set(result["score"])
            return {
                **result,
                "metadata": {
                    "symbol": symbol,
                    "timestamp": start.isoformat() + "Z",
                    "version": self.version
                }
            }
        except Exception as e:
            ERROR_COUNTER.labels(module='trend').inc()
            logger.error(f"Trend computation failed for {symbol}: {e}")
            return {"score": 0.5, "signal": "neutral"}

    async def _calculate_metrics(self, df: pd.DataFrame) -> Dict[str, float]:
        """VektÃ¶rize metrik hesaplamalarÄ±"""
        close = df['close']
        params = self.config.get("parameters", {})
        metrics = {}

        # EMA
        for p in params.get("ema_periods", [9, 21, 50]):
            metrics[f"ema_{p}"] = float(close.ewm(span=p, adjust=False).mean().iloc[-1])

        # RSI
        diff = close.diff()
        gain = diff.clip(lower=0).rolling(params.get("rsi_period", 14)).mean()
        loss = -diff.clip(upper=0).rolling(params.get("rsi_period", 14)).mean()
        rs = gain / (loss + 1e-9)
        metrics["rsi"] = float((100 - (100 / (1 + rs))).iloc[-1] / 100)

        # MACD
        fast, slow, signal = params.get("macd_params", {"fast": 12, "slow": 26, "signal": 9}).values()
        ema_fast = close.ewm(span=fast).mean()
        ema_slow = close.ewm(span=slow).mean()
        macd = ema_fast - ema_slow
        macd_signal = macd.ewm(span=signal).mean()
        metrics["macd_histogram"] = float(macd.sub(macd_signal).iloc[-1])

        # Kalman & Z-score
        metrics["kalman_trend"] = float(np.clip(np.mean(close.pct_change()) / (np.std(close.pct_change()) + 1e-9), 0, 1))
        metrics["z_score"] = float(((close - close.rolling(20).mean()) / close.rolling(20).std()).iloc[-1])

        return metrics

    def _aggregate(self, metrics: Dict[str, float]) -> Dict[str, Any]:
        weights = self.config.get("weights", {})
        thresholds = self.config.get("thresholds", {})
        formula = self.config.get("composite_formula")

        if formula:
            # Dinamik formÃ¼l Ã§Ã¶zÃ¼mleme
            local_env = {k: v for k, v in metrics.items()}
            try:
                score = eval(formula, {}, local_env)
            except Exception:
                score = sum(v * weights.get(k, 0) for k, v in metrics.items())
        else:
            score = sum(v * weights.get(k, 0) for k, v in metrics.items())

        score = float(np.clip(score, 0, 1))
        signal = "bullish" if score >= thresholds["bullish"] else "bearish" if score <= thresholds["bearish"] else "neutral"

        return {
            "score": score,
            "signal": signal,
            "components": metrics
        }







=================================================================
===	4- modÃ¼le ait config ÅŸablonu
=================================================================
"""
Trend Analysis Module Configuration
-----------------------------------
Versiyon: 2.2.0 | Lifecycle: Production

ðŸ”§ Bu ÅŸablon, trend analiz modÃ¼lÃ¼ iÃ§in tip gÃ¼venli (type-safe) yapÄ± sunar.
TÃ¼m parametreler modÃ¼l ile tam uyumludur.
"""

from typing import Dict, Any, List, Optional
from pydantic import BaseModel, Field, validator

from analysis.config.base import BaseModuleConfig


class TrendConfig(BaseModuleConfig):
    """Trend modÃ¼lÃ¼ iÃ§in tip gÃ¼venli config"""

    # === PARAMETRELER ===
    parameters: Dict[str, Any] = Field(
        default_factory=lambda: {
            "ema_periods": [9, 21, 50],
            "rsi_period": 14,
            "macd_params": {"fast": 12, "slow": 26, "signal": 9},
            "kalman_observation_noise": 0.1,
            "zscore_window": 20
        },
        description="Trend analizinde kullanÄ±lacak parametre seti"
    )

    # === AÄžIRLIKLAR ===
    weights: Dict[str, float] = Field(
        default_factory=lambda: {
            "ema_9": 0.15,
            "ema_21": 0.15,
            "ema_50": 0.10,
            "rsi": 0.20,
            "macd_histogram": 0.25,
            "kalman_trend": 0.15
        },
        description="Her metrik iÃ§in aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ±"
    )

    # === EÅžÄ°KLER ===
    thresholds: Dict[str, float] = Field(
        default_factory=lambda: {
            "bullish": 0.65,
            "bearish": 0.35,
            "strong_trend": 0.75,
            "weak_trend": 0.25
        },
        description="Sinyal Ã¼retiminde kullanÄ±lacak eÅŸikler"
    )

    # === NORMALÄ°ZASYON ===
    normalization: Dict[str, str] = Field(
        default_factory=lambda: {"method": "zscore"},
        description="Normalizasyon yÃ¶ntemi"
    )

    # === PERFORMANS AYARLARI ===
    performance: Dict[str, Any] = Field(
        default_factory=lambda: {"cache_ttl": 300, "timeout": 30, "max_retries": 3},
        description="Performans ve Ã¶nbellek ayarlarÄ±"
    )

    # === BÄ°LEÅžÄ°K FORMÃœL (Opsiyonel) ===
    composite_formula: Optional[str] = Field(
        default="0.25*macd_histogram + 0.2*rsi + 0.2*ema_21 + 0.15*kalman_trend + 0.1*z_score + 0.1*ema_9",
        description="AÄŸÄ±rlÄ±klÄ± metrikleri birleÅŸtiren Ã¶zel formÃ¼l (opsiyonel)"
    )

    # === VALIDATORS ===
    @validator('weights')
    def validate_weights(cls, v):
        total = sum(v.values())
        if not 0.99 <= total <= 1.01:
            raise ValueError(f"Weights must sum to 1.0, got {total:.3f}")
        return v

    @validator('thresholds')
    def validate_thresholds(cls, v):
        if 'bullish' in v and 'bearish' in v:
            if v['bullish'] <= v['bearish']:
                raise ValueError('Bullish threshold must be greater than bearish threshold')
        return v


# === CONFIG INSTANCE ===
TREND_CONFIG = TrendConfig(
    module_name="TrendAnalysis",
    version="2.2.0",
    lifecycle="production"
)






=================================================================
===	5- veri kaynaÄŸÄ± sÄ±nÄ±f ve alt endpoid isim bilgisi
=================================================================
class ResponseCache:
    def cache_key(user_id, endpoint, params):

class MultiUserAggregatorSettings:
    # Multi-user configuration for Binance API aggregator.
    # Her kullanÄ±cÄ± iÃ§in ayrÄ± HTTP client ve circuit breaker yÃ¶netimi.
    # Enhanced with lazy initialization and async safety
    def __init__(self):
    def get_instance(cls):
    async def _check_rate_limits(self, user_id):
        # Check and enforce rate limits
    async def ensure_cleanup_task(self):
        # Thread-safe lazy initialization of cleanup task
    async def _start_cleanup_task(self):
        # Async cleanup task initialization
    def _handle_cleanup_task_exception(self, task):
        # Cleanup task exception handler
    async def get_user_client(self, user_id, retry_count):
        # âœ… PERFORMANS + GÃœVENLÄ°K
    async def _cleanup_inactive_users(self):
        # Inactive user'larÄ± temizle (30dk TTL)
    async def _evict_least_used_user(self):
        # LRU cache eviction
    def _validate_user_id(user_id):
        # User ID validation
    def _is_valid_api_key_format(api_key):
        # API key format validation
    def _mask_api_key(api_key):
        # API key masking for logging
    def _get_user_lock(self, user_id):
        # Get or create user-specific lock.
    async def get_user_circuit_breaker(self, user_id):
        # Get or create user-specific circuit breaker.
    async def cleanup_user_resources(self, user_id):
        # Cleanup user-specific resources.
    async def get_all_active_users(self):
        # Get list of all active users with clients.
    def get_metrics(self):
        # Performance metrics getter
    async def close(self):
        # Cleanup all resources and tasks.

class MultiUserPublicApi:
    # Multi-user compatible Public API.
    # Public endpoints don't require user authentication but can track user context.
    def __init__(self):

class MultiUserPrivateApi:
    # Multi-user Private API with enhanced user management.
    def __init__(self):
    async def _get_user_base_client(self, user_id):
        # Get user-specific base client.

class MultiUserBinanceAggregator:
    # Enhanced aggregator with proper async lifecycle management
    def __init__(self):
    def get_instance(cls):
        # Sync singleton getter - for backward compatibility
    async def create(cls):
        # Async factory method - recommended for new code
    async def start(self):
        # Explicit startup - required before use
    async def health_check(self, user_id):
        # âœ… Startup kontrolÃ¼ ekle
    async def validate_user_credentials(self, user_id):
        # Validate user's Binance credentials.
    async def get_user_status(self, user_id):
        # âœ… DAHA DETAYLI USER STATUS
    async def get_all_users_status(self):
        # Get status for all active users.
    async def cleanup_user(self, user_id):
        # Cleanup resources for a specific user.
    def get_stats(self):
        # Get aggregator statistics.
    async def close(self):
        # Cleanup all resources.
    async def __aenter__(self):
    async def __aexit__(self, exc_type, exc_val, exc_tb):

class BinanceAggregator:
    # Backward compatibility wrapper
    # Legacy compatibility with auto-start
    def __init__(self, http_client):
    async def _ensure_started(self):
        # Auto-start mechanism for legacy code
    async def get_instance(cls, http_client):
        # Async singleton for legacy code
    def public(self):
    def private(self):
    async def health_check(self):
    def get_stats(self):

